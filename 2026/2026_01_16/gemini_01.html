<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>France Trip 2026 - Itinerary Visualiser</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --bg: #f8fafc;
            --text: #1e293b;
            --option-a: #2563eb;
            --option-b: #db2777;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Header & Controls --- */
        header {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            justify-content: center;
        }

        .tab-btn {
            padding: 0.5rem 2rem;
            border: 2px solid #e2e8f0;
            border-radius: 2rem;
            background: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-btn.active.opt-a { background: var(--option-a); color: white; border-color: var(--option-a); }
        .tab-btn.active.opt-b { background: var(--option-b); color: white; border-color: var(--option-b); }

        .controls {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .play-btn {
            background: var(--text);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slider-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        input[type=range] {
            width: 100%;
            cursor: pointer;
        }

        .status-text {
            font-size: 1.1rem;
            font-weight: bold;
            min-width: 250px;
            text-align: center;
        }

        /* --- Main Layout --- */
        main {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        #map-container {
            flex: 1; /* Takes remaining space */
            background: #e0f2fe;
            position: relative;
        }

        #calendar-container {
            width: 350px;
            background: white;
            padding: 1rem;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        /* --- Map Styles --- */
        path.country {
            fill: #ffffff;
            stroke: #cbd5e1;
            stroke-width: 1px;
        }
        
        .connection-line {
            fill: none;
            stroke-width: 3px;
            stroke-linecap: round;
            opacity: 0.6;
        }

        .city-marker {
            cursor: pointer;
            transition: r 0.3s;
        }

        .city-label {
            font-size: 12px;
            font-weight: 600;
            fill: #334155;
            text-shadow: 0 1px 2px white;
            pointer-events: none;
        }
        
        .context-city-label {
            font-size: 10px;
            fill: #94a3b8;
            font-style: italic;
        }

        .order-badge {
            font-size: 10px;
            fill: white;
            font-weight: bold;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: central;
        }

        .traveler-marker {
            fill: #f59e0b;
            stroke: white;
            stroke-width: 2px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }

        /* --- Calendar Styles --- */
        .calendar-header {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            font-size: 0.8rem;
        }

        .day-name {
            text-align: center;
            color: #64748b;
            font-size: 0.75rem;
            margin-bottom: 5px;
        }

        .cal-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            background: #f1f5f9;
            color: #94a3b8;
            position: relative;
        }

        .cal-day.trip-day {
            background: #dbeafe;
            color: var(--text);
            font-weight: bold;
            border: 1px solid #bfdbfe;
        }

        .cal-day.active-day {
            background: var(--text);
            color: white;
            transform: scale(1.1);
            transition: all 0.2s;
            z-index: 2;
        }

        .cal-day.weekend {
            border-bottom: 3px solid #cbd5e1;
        }

        /* --- Mobile Responsiveness --- */
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            #calendar-container {
                width: 100%;
                height: 35%;
                border-left: none;
                border-top: 1px solid #e2e8f0;
            }
            #map-container {
                height: 65%;
            }
            .controls {
                flex-wrap: wrap;
                gap: 0.5rem;
                padding: 0 1rem;
            }
            .status-text {
                font-size: 0.9rem;
                min-width: 100%;
                order: -1;
            }
            header {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="tabs">
        <button class="tab-btn opt-a" onclick="setOption('A')">Option A (Ternand Last)</button>
        <button class="tab-btn opt-b active" onclick="setOption('B')">Option B (Ternand First)</button>
    </div>
    <div class="controls">
        <button class="play-btn" id="playBtn" onclick="togglePlay()">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <div class="slider-container">
            <input type="range" id="progressSlider" min="0" max="11" value="0" step="1">
        </div>
    </div>
    <div class="status-text" id="statusDisplay">Loading...</div>
</header>

<main>
    <div id="map-container"></div>
    <div id="calendar-container">
        <div class="calendar-header">August 2026</div>
        <div class="calendar-grid" id="calendarGrid">
            <!-- JS will populate -->
        </div>
        <div style="margin-top: 20px; font-size: 0.85rem; color: #64748b; line-height: 1.4;">
            <p><strong>Ardeche Destination:</strong> Vallon-Pont-d'Arc.</p>
            <p>Chosen for its central access to the Pont d'Arc, the Gorges, and the Chauvet 2 Cave (replica of the oldest decorated cave in the world).</p>
        </div>
    </div>
</main>

<script>
    // --- Configuration & Data ---
    
    // Coordinates [Lon, Lat]
    const locations = {
        lyon: [4.8357, 45.7640],
        ternand: [4.5290, 45.9460],
        carcassonne: [2.3537, 43.2121],
        ardeche: [4.3956, 44.4062], // Vallon-Pont-d'Arc
        paris: [2.3522, 48.8566],
        geneva: [6.1432, 46.2044],
        chamonix: [6.8694, 45.9237]
    };

    // Itinerary Options
    // type: 'stay' or 'move'
    // date: Day of August
    const itineraries = {
        A: {
            color: '#2563eb',
            schedule: [
                { day: 20, loc: 'lyon', text: "Arrive in Lyon", type: 'stay' },
                { day: 21, loc: 'carcassonne', text: "Drive to Carcassonne (4.5 hrs)", type: 'move', from: 'lyon' },
                { day: 22, loc: 'carcassonne', text: "Explore Carcassonne", type: 'stay' },
                { day: 23, loc: 'carcassonne', text: "Relax in Carcassonne", type: 'stay' },
                { day: 24, loc: 'ardeche', text: "Drive to Ardeche (Vallon-Pont-d'Arc)", type: 'move', from: 'carcassonne' },
                { day: 25, loc: 'ardeche', text: "Ardeche: Pont d'Arc & Gorges", type: 'stay' },
                { day: 26, loc: 'ardeche', text: "Ardeche: Chauvet Cave 2", type: 'stay' },
                { day: 27, loc: 'ternand', text: "Drive to Ternand (3 hours)", type: 'move', from: 'ardeche' },
                { day: 28, loc: 'ternand', text: "Relax in Ternand", type: 'stay' },
                { day: 29, loc: 'ternand', text: "Lunch at Restaurant", type: 'stay' },
                { day: 30, loc: 'lyon', text: "Drive to Lyon", type: 'move', from: 'ternand' },
                { day: 31, loc: 'lyon', text: "Depart Lyon", type: 'stay' }
            ]
        },
        B: {
            color: '#db2777',
            schedule: [
                { day: 20, loc: 'ternand', text: "Arrive Lyon -> Drive Ternand (1.5 hrs)", type: 'move', from: 'lyon' },
                { day: 21, loc: 'ternand', text: "Relax in Ternand", type: 'stay' },
                { day: 22, loc: 'ternand', text: "Lunch at Restaurant", type: 'stay' },
                { day: 23, loc: 'carcassonne', text: "Drive to Carcassonne (5 hrs 20)", type: 'move', from: 'ternand' },
                { day: 24, loc: 'carcassonne', text: "Explore Carcassonne", type: 'stay' },
                { day: 25, loc: 'carcassonne', text: "Relax in Carcassonne", type: 'stay' },
                { day: 26, loc: 'ardeche', text: "Drive to Ardeche (Vallon-Pont-d'Arc)", type: 'move', from: 'carcassonne' },
                { day: 27, loc: 'ardeche', text: "Ardeche: Pont d'Arc", type: 'stay' },
                { day: 28, loc: 'ardeche', text: "Ardeche: Gorges & Caves", type: 'stay' },
                { day: 29, loc: 'lyon', text: "Drive to Lyon (2 hrs)", type: 'move', from: 'ardeche' },
                { day: 30, loc: 'lyon', text: "Explore Lyon", type: 'stay' },
                { day: 31, loc: 'lyon', text: "Depart Lyon", type: 'stay' }
            ]
        }
    };

    // State
    let currentOption = 'A';
    let currentIndex = 0;
    let isPlaying = false;
    let playInterval = null;
    let mapSvg, projection, pathGenerator;

    // --- Initialization ---

    function init() {
        // Setup Calendar
        drawCalendar();
        
        // Setup Map
        initMap().then(() => {
            updateUI();
        });

        // Event Listeners
        document.getElementById('progressSlider').addEventListener('input', (e) => {
            pause();
            currentIndex = parseInt(e.target.value);
            updateUI();
        });
    }

    // --- Calendar Logic ---

    function drawCalendar() {
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        
        // Days of week header
        const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        days.forEach(d => {
            const el = document.createElement('div');
            el.className = 'day-name';
            el.innerText = d;
            grid.appendChild(el);
        });

        // August 2026 starts on a Saturday (1st). 
        // We need 5 empty slots for Mon-Fri.
        for(let i=0; i<5; i++) {
            const empty = document.createElement('div');
            grid.appendChild(empty);
        }

        // 31 Days
        for(let i=1; i<=31; i++) {
            const d = document.createElement('div');
            d.className = 'cal-day';
            d.innerText = i;
            d.id = `cal-day-${i}`;
            
            // Mark Weekend
            // Aug 1 is Sat (6), Aug 2 is Sun (7)
            // (Day + Offset) % 7 
            // Offset for Sat start is 5. (1+5)%7 = 6 (Sat)
            const weekDay = (i + 4) % 7; 
            if(weekDay === 6 || weekDay === 0) {
                d.classList.add('weekend');
            }
            
            grid.appendChild(d);
        }
    }

    // --- Map Logic (D3) ---

    async function initMap() {
        const width = document.getElementById('map-container').clientWidth;
        const height = document.getElementById('map-container').clientHeight;

        mapSvg = d3.select("#map-container").append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width} ${height}`);

        // Projection centered on France
        projection = d3.geoConicConformal()
            .center([2.454071, 46.279229])
            .scale(height * 4) // Adjust scale based on screen height
            .translate([width / 2, height / 2]);

        pathGenerator = d3.geoPath().projection(projection);

        // Fetch France GeoJSON (Regions)
        try {
            const res = await fetch('https://raw.githubusercontent.com/gregoiredavid/france-geojson/master/regions-version-simplifiee.geojson');
            const data = await res.json();
            
            mapSvg.selectAll("path")
                .data(data.features)
                .enter()
                .append("path")
                .attr("class", "country")
                .attr("d", pathGenerator);

        } catch (e) {
            console.error("Could not load map data", e);
            mapSvg.append("text").attr("x", width/2).attr("y", height/2).text("Map outline unavailable");
        }

        // Draw Context Cities (Paris, etc)
        const contextCities = ['paris', 'geneva', 'chamonix'];
        contextCities.forEach(cityKey => {
            const coords = projection(locations[cityKey]);
            mapSvg.append("circle")
                .attr("cx", coords[0])
                .attr("cy", coords[1])
                .attr("r", 3)
                .attr("fill", "#94a3b8");
            
            mapSvg.append("text")
                .attr("class", "city-label context-city-label")
                .attr("x", coords[0] + 5)
                .attr("y", coords[1] + 3)
                .text(cityKey.charAt(0).toUpperCase() + cityKey.slice(1));
        });

        // Initialize dynamic layers
        mapSvg.append("g").attr("id", "routes-layer");
        mapSvg.append("g").attr("id", "stops-layer");
        
        // Define Arrowhead Marker
        mapSvg.append("defs").append("marker")
            .attr("id", "arrow")
            .attr("viewBox", "0 -5 10 10")
            .attr("refX", 15) // Position of arrow relative to line end
            .attr("refY", 0)
            .attr("markerWidth", 6)
            .attr("markerHeight", 6)
            .attr("orient", "auto")
            .append("path")
            .attr("d", "M0,-5L10,0L0,5")
            .attr("fill", "var(--option-a)"); // Will change dynamically

        // Traveler Marker
        mapSvg.append("circle")
            .attr("id", "traveler")
            .attr("class", "traveler-marker")
            .attr("r", 8)
            .attr("opacity", 0);
    }

    function drawRoutes(optionKey) {
        const sched = itineraries[optionKey].schedule;
        const color = itineraries[optionKey].color;
        
        // Clear previous
        const routesLayer = d3.select("#routes-layer");
        routesLayer.selectAll("*").remove();
        
        const stopsLayer = d3.select("#stops-layer");
        stopsLayer.selectAll("*").remove();

        // Update Arrow Color
        d3.select("#arrow path").attr("fill", color);

        // Extract unique movements and stops
        let stops = [];
        let visitedKeys = new Set();
        let moveIndex = 1;

        // Draw Stops
        sched.forEach((item, i) => {
            const coords = projection(locations[item.loc]);
            
            // If it's a move, draw a line from previous
            if (item.type === 'move') {
                const startCoords = projection(locations[item.from]);
                
                routesLayer.append("path")
                    .datum({type: "LineString", coordinates: [locations[item.from], locations[item.loc]]})
                    .attr("class", "connection-line")
                    .attr("stroke", color)
                    .attr("d", d3.geoPath().projection(projection))
                    .attr("marker-end", "url(#arrow)");
            }

            // Draw stop circle only once per sequence (simplified visualization)
            // Or draw numbers representing order of arrival?
            // Let's draw numbers at destinations in order of itinerary
            if (item.type === 'stay' || item.type === 'move') {
               // Only add marker if we haven't labeled this location recently? 
               // No, let's mark every destination arrival with a small number
               
               // Check if this is a new arrival or start
               const isNewLoc = i===0 || sched[i-1].loc !== item.loc;
               
               if(isNewLoc) {
                   stopsLayer.append("circle")
                       .attr("cx", coords[0])
                       .attr("cy", coords[1])
                       .attr("r", 12)
                       .attr("fill", color)
                       .attr("stroke", "white")
                       .attr("stroke-width", 2);
                   
                   stopsLayer.append("text")
                       .attr("class", "order-badge")
                       .attr("x", coords[0])
                       .attr("y", coords[1])
                       .text(moveIndex++);
                   
                   // City Name Label (if not already there)
                   if (!visitedKeys.has(item.loc)) {
                       stopsLayer.append("text")
                           .attr("class", "city-label")
                           .attr("x", coords[0] + 14)
                           .attr("y", coords[1] + 4)
                           .text(item.loc === 'ardeche' ? "Vallon-Pont-d'Arc" : item.loc.charAt(0).toUpperCase() + item.loc.slice(1));
                       visitedKeys.add(item.loc);
                   }
               }
            }
        });
    }

    // --- Core Logic ---

    function setOption(opt) {
        currentOption = opt;
        
        // UI Tabs
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-btn.opt-${opt.toLowerCase()}`).classList.add('active');

        // Draw static map elements for this option
        drawRoutes(opt);
        
        // Reset timeline if desired, or keep day index?
        // Let's keep day index but refresh visuals
        updateUI();
    }

    function togglePlay() {
        if (isPlaying) {
            pause();
        } else {
            play();
        }
    }

    function play() {
        isPlaying = true;
        document.getElementById('playBtn').innerHTML = `<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`;
        
        // If at end, restart
        const sched = itineraries[currentOption].schedule;
        if (currentIndex >= sched.length - 1) {
            currentIndex = 0;
            document.getElementById('progressSlider').value = 0;
        }

        updateUI(); // Immediate update

        playInterval = setInterval(() => {
            if (currentIndex < sched.length - 1) {
                currentIndex++;
                document.getElementById('progressSlider').value = currentIndex;
                updateUI();
            } else {
                pause();
            }
        }, 1200); // 1.2 seconds per day
    }

    function pause() {
        isPlaying = false;
        clearInterval(playInterval);
        document.getElementById('playBtn').innerHTML = `<svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>`;
    }

    function updateUI() {
        const sched = itineraries[currentOption].schedule;
        const currentData = sched[currentIndex];

        // Update Text
        const statusEl = document.getElementById('statusDisplay');
        const dateStr = `Aug ${currentData.day}`;
        statusEl.innerHTML = `<span style="color:${itineraries[currentOption].color}">${dateStr}:</span> ${currentData.text}`;

        // Update Calendar Highlights
        document.querySelectorAll('.cal-day').forEach(el => {
            el.classList.remove('trip-day', 'active-day');
            el.style.backgroundColor = '';
            el.style.borderColor = '';
        });

        // Highlight Range
        sched.forEach(item => {
            const el = document.getElementById(`cal-day-${item.day}`);
            if(el) {
                el.classList.add('trip-day');
            }
        });

        // Highlight Current
        const activeEl = document.getElementById(`cal-day-${currentData.day}`);
        if(activeEl) {
            activeEl.classList.add('active-day');
            activeEl.style.backgroundColor = itineraries[currentOption].color;
        }

        // Update Traveler Position on Map
        const traveler = d3.select("#traveler");
        traveler.attr("opacity", 1);
        
        const targetCoords = projection(locations[currentData.loc]);

        if (currentData.type === 'stay' || currentIndex === 0) {
            // Jump to location
            traveler.transition().duration(500)
                .attr("cx", targetCoords[0])
                .attr("cy", targetCoords[1]);
        } else if (currentData.type === 'move') {
            // Animate along path
            const startCoords = projection(locations[currentData.from]);
            
            traveler.attr("cx", startCoords[0]).attr("cy", startCoords[1]); // Reset to start
            
            traveler.transition().duration(1000).ease(d3.easeLinear)
                .attr("cx", targetCoords[0])
                .attr("cy", targetCoords[1]);
        }
    }

    // Handle resize
    window.addEventListener('resize', () => {
        d3.select("svg").remove();
        initMap().then(() => {
            drawRoutes(currentOption);
            updateUI();
        });
    });

    // Start
    init();

    // Trigger initial route draw
    drawRoutes('B');
    updateUI();

</script>
</body>
</html>